<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Инструмент Записи Действий</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #controls {
            margin-bottom: 20px;
        }
        #instructions {
            margin-top: 40px;
        }
        .step {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .step img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Инструмент Записи Действий в Браузере</h1>
    <div id="controls">
        <button id="startBtn">Начать запись</button>
        <button id="stopBtn" disabled>Остановить запись</button>
        <button id="generateBtn">Сгенерировать инструкцию</button>
    </div>
    <div id="instructions">
        <h2>Пошаговая Инструкция</h2>
        <div id="steps"></div>
    </div>

    <!-- Подключаем библиотеку html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        let recording = false;
        let steps = [];

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const generateBtn = document.getElementById('generateBtn');
        const stepsContainer = document.getElementById('steps');

        startBtn.addEventListener('click', () => {
            recording = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            steps = [];
            alert('Запись началась. Все клики внутри страницы будут записываться.');
        });

        stopBtn.addEventListener('click', () => {
            recording = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            alert('Запись остановлена.');
            // Сохраняем шаги в LocalStorage
            localStorage.setItem('steps', JSON.stringify(steps));
        });

        generateBtn.addEventListener('click', () => {
            // Загружаем шаги из LocalStorage
            const savedSteps = JSON.parse(localStorage.getItem('steps'));
            if (!savedSteps || savedSteps.length === 0) {
                alert('Нет записанных шагов для генерации инструкции.');
                return;
            }
            stepsContainer.innerHTML = '';
            savedSteps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.innerHTML = `
                    <h3>Шаг ${index + 1}</h3>
                    <p>${step.description}</p>
                    <img src="${step.screenshot}" alt="Скриншот шага ${index + 1}">
                `;
                stepsContainer.appendChild(stepDiv);
            });
            alert('Инструкция сгенерирована ниже.');
        });

        // Функция для создания описания действия
        function describeEvent(event) {
            let description = `Клик по элементу <strong>${event.target.tagName}</strong>`;
            if (event.target.id) {
                description += ` с id <strong>${event.target.id}</strong>`;
            }
            if (event.target.className) {
                description += ` и классом <strong>${event.target.className}</strong>`;
            }
            return description;
        }

        // Обработчик кликов
        document.addEventListener('click', async (event) => {
            if (!recording) return;

            // Останавливаем распространение события, чтобы предотвратить нежелательные эффекты
            event.preventDefault();
            event.stopPropagation();

            // Создаем скриншот всей страницы
            const canvas = await html2canvas(document.body);
            const imgData = canvas.toDataURL('image/png');

            // Описываем действие
            const description = describeEvent(event);

            // Добавляем шаг
            steps.push({
                description: description,
                screenshot: imgData
            });

            // Визуальная индикация записи клика (опционально)
            event.target.style.border = '2px solid red';
            setTimeout(() => {
                event.target.style.border = '';
            }, 500);
        }, true); // Используем фазу захвата
    </script>
</body>
</html>
